<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cherry Blossom Garden - Immersive Meditative Experience</title>
    <style>
        :root {
            /* Primitive Color Tokens */
            --color-white: rgba(255, 255, 255, 1);
            --color-black: rgba(0, 0, 0, 1);
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-gray-400: rgba(119, 124, 124, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-brown-600: rgba(94, 82, 64, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-teal-300: rgba(50, 184, 198, 1);
            --color-teal-400: rgba(45, 166, 178, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-teal-700: rgba(26, 104, 115, 1);
            --color-teal-800: rgba(41, 150, 161, 1);
            --color-red-400: rgba(255, 84, 89, 1);
            --color-red-500: rgba(192, 21, 47, 1);
            --color-orange-400: rgba(230, 129, 97, 1);
            --color-orange-500: rgba(168, 75, 47, 1);

            /* RGB versions for opacity control */
            --color-brown-600-rgb: 94, 82, 64;
            --color-teal-500-rgb: 33, 128, 141;
            --color-slate-900-rgb: 19, 52, 59;
            --color-slate-500-rgb: 98, 108, 113;
            --color-red-500-rgb: 192, 21, 47;
            --color-red-400-rgb: 255, 84, 89;
            --color-orange-500-rgb: 168, 75, 47;
            --color-orange-400-rgb: 230, 129, 97;

            /* Semantic Color Tokens */
            --color-background: var(--color-cream-50);
            --color-surface: var(--color-cream-100);
            --color-text: var(--color-slate-900);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-border: rgba(var(--color-brown-600-rgb), 0.2);

            /* Typography */
            --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --font-size-xs: 11px;
            --font-size-sm: 12px;
            --font-size-base: 14px;
            --font-weight-medium: 500;
            --font-weight-semibold: 550;

            /* Spacing */
            --space-8: 8px;
            --space-12: 12px;
            --space-16: 16px;
            --space-20: 20px;

            /* Border Radius */
            --radius-base: 8px;
            --radius-lg: 12px;

            /* Shadows */
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);

            /* Animation */
            --duration-normal: 250ms;
            --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);
            --ease-out: cubic-bezier(0, 0, 0.2, 1);
            --ease-in: cubic-bezier(0.4, 0, 1, 1);
        }

        @font-face {
            font-family: 'FKGroteskNeue';
            src: url('https://r2cdn.perplexity.ai/fonts/FKGroteskNeue.woff2') format('woff2');
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family-base);
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            position: relative;
            background: var(--color-slate-900);
        }

        #garden-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transition: filter 0.5s ease;
        }

        #garden-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .scene-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transition: opacity 0.5s ease;
        }

        /* Welcome Screen */
        #welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--color-slate-900) 0%, var(--color-charcoal-700) 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            transition: opacity 1s var(--ease-out), visibility 1s;
            color: var(--color-white);
            text-align: center;
            padding: var(--space-20);
        }

        #welcome-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .welcome-content {
            max-width: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-20);
        }

        .welcome-title {
            font-size: 3.5rem;
            font-weight: 600;
            margin-bottom: var(--space-12);
            background: linear-gradient(135deg, #FFB6C1 0%, #DDA0DD 50%, #B0C4DE 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .welcome-subtitle {
            font-size: 1.25rem;
            color: var(--color-gray-300);
            margin-bottom: var(--space-20);
            max-width: 500px;
            line-height: 1.6;
        }

        .welcome-features {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-16);
            margin-bottom: var(--space-20);
            justify-content: center;
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: var(--space-8);
            font-size: var(--font-size-base);
            color: var(--color-gray-300);
        }

        .feature-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #enter-garden {
            padding: var(--space-16) var(--space-20);
            background: linear-gradient(135deg, var(--color-teal-500) 0%, var(--color-teal-700) 100%);
            color: white;
            border: none;
            border-radius: var(--radius-lg);
            font-size: 1.1rem;
            font-weight: var(--font-weight-semibold);
            cursor: pointer;
            transition: all var(--duration-normal) var(--ease-standard);
            box-shadow: 0 4px 14px 0 rgba(33, 128, 141, 0.4);
        }

        #enter-garden:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px 0 rgba(33, 128, 141, 0.6);
        }

        /* Control Panel */
        #control-panel {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: var(--space-20);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            max-height: 90vh;
            overflow-y: auto;
            z-index: 1000;
            width: 280px;
            transition: transform var(--duration-normal) var(--ease-standard);
        }

        #control-panel.hidden {
            transform: translate(320px, -50%);
        }

        #toggle-panel {
            position: fixed;
            right: 20px;
            top: 20px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: none;
            padding: 12px;
            border-radius: var(--radius-base);
            cursor: pointer;
            z-index: 1001;
            box-shadow: var(--shadow-lg);
            transition: background var(--duration-normal) var(--ease-standard);
        }

        #toggle-panel:hover {
            background: rgba(255, 255, 255, 1);
        }

        .control-section {
            margin-bottom: var(--space-20);
            padding-bottom: var(--space-16);
            border-bottom: 1px solid var(--color-border);
        }

        .control-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .control-section h3 {
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text);
            margin-bottom: var(--space-12);
        }

        .control-item {
            margin-bottom: var(--space-12);
        }

        .control-item label {
            display: block;
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            margin-bottom: 6px;
            font-weight: var(--font-weight-medium);
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
        }

        .toggle-switch input {
            display: none;
        }

        .toggle-slider {
            width: 44px;
            height: 24px;
            background: var(--color-border);
            border-radius: 12px;
            position: relative;
            transition: background var(--duration-normal) var(--ease-standard);
        }

        .toggle-slider::after {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: white;
            top: 3px;
            left: 3px;
            transition: transform var(--duration-normal) var(--ease-standard);
        }

        .toggle-switch input:checked + .toggle-slider {
            background: var(--color-primary);
        }

        .toggle-switch input:checked + .toggle-slider::after {
            transform: translateX(20px);
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--color-border);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--color-primary);
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--color-primary);
            cursor: pointer;
            border: none;
        }

        .slider-value {
            display: inline-block;
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
            margin-left: var(--space-8);
        }

        .color-options {
            display: flex;
            gap: var(--space-8);
            flex-wrap: wrap;
        }

        .color-option {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-base);
            cursor: pointer;
            border: 2px solid transparent;
            transition: all var(--duration-normal) var(--ease-standard);
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.active {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(var(--color-teal-500-rgb), 0.2);
        }

        .action-buttons {
            display: flex;
            gap: var(--space-8);
            flex-direction: column;
        }

        .btn {
            padding: var(--space-12) var(--space-16);
            border: none;
            border-radius: var(--radius-base);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all var(--duration-normal) var(--ease-standard);
            font-family: var(--font-family-base);
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
        }

        .btn-secondary {
            background: rgba(var(--color-brown-600-rgb), 0.12);
            color: var(--color-text);
        }

        .btn-secondary:hover {
            background: rgba(var(--color-brown-600-rgb), 0.2);
        }

        /* Fullscreen styles */
        .fullscreen #control-panel {
            max-height: 100vh;
        }

        /* Scrollbar styling */
        #control-panel::-webkit-scrollbar {
            width: 6px;
        }

        #control-panel::-webkit-scrollbar-track {
            background: transparent;
        }

        #control-panel::-webkit-scrollbar-thumb {
            background: var(--color-border);
            border-radius: 3px;
        }

        #control-panel::-webkit-scrollbar-thumb:hover {
            background: var(--color-text-secondary);
        }

        /* Performance Monitor */
        #performance-monitor {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: var(--space-8) var(--space-12);
            border-radius: var(--radius-base);
            font-size: var(--font-size-xs);
            z-index: 1000;
            backdrop-filter: blur(5px);
            display: none;
        }

        /* Loading Screen */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--color-slate-900);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            color: white;
            transition: opacity 0.5s ease;
        }

        #loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--color-teal-400);
            animation: spin 1s ease-in-out infinite;
            margin-bottom: var(--space-20);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: var(--font-size-base);
            color: var(--color-gray-300);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            #control-panel {
                width: 260px;
                right: 10px;
            }
            
            .welcome-title {
                font-size: 2.5rem;
            }
            
            .welcome-subtitle {
                font-size: 1rem;
            }
        }

        @media (max-width: 480px) {
            #control-panel {
                width: 240px;
                padding: var(--space-16);
            }
            
            .welcome-title {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading Cherry Blossom Garden...</div>
    </div>

    <div id="welcome-screen">
        <div class="welcome-content">
            <h1 class="welcome-title">Cherry Blossom Garden</h1>
            <p class="welcome-subtitle">An immersive, meditative experience featuring dynamic cherry blossoms, flowing water, and atmospheric day/night cycles.</p>
            
            <div class="welcome-features">
                <div class="feature-item">
                    <div class="feature-icon">üå∏</div>
                    <span>Dynamic Petal Physics</span>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">üåä</div>
                    <span>Flowing Water Simulation</span>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">üåô</div>
                    <span>Day/Night Cycle</span>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">üé®</div>
                    <span>Customizable Colors</span>
                </div>
            </div>
            
            <button id="enter-garden">Enter the Garden</button>
        </div>
    </div>

    <div id="garden-container">
        <canvas id="garden-canvas"></canvas>
    </div>

    <button id="toggle-panel" aria-label="Toggle Controls">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M12 1v6m0 6v6m9-9h-6m-6 0H3"></path>
        </svg>
    </button>

    <div id="control-panel">
        <div class="control-section">
            <h3>Scene Elements</h3>
            <div class="control-item">
                <label class="toggle-switch">
                    <span>Cherry Trees</span>
                    <input type="checkbox" id="toggle-trees" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="control-item">
                <label class="toggle-switch">
                    <span>Falling Petals</span>
                    <input type="checkbox" id="toggle-petals" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="control-item">
                <label class="toggle-switch">
                    <span>River</span>
                    <input type="checkbox" id="toggle-river" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="control-item">
                <label class="toggle-switch">
                    <span>Stone Path</span>
                    <input type="checkbox" id="toggle-path" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <div class="control-section">
            <h3>Animations</h3>
            <div class="control-item">
                <label>
                    Petal Speed <span class="slider-value" id="petal-speed-value">1.0x</span>
                </label>
                <input type="range" id="petal-speed" min="50" max="200" value="100" step="10">
            </div>
            <div class="control-item">
                <label>
                    Water Flow <span class="slider-value" id="water-speed-value">1.0x</span>
                </label>
                <input type="range" id="water-speed" min="50" max="200" value="100" step="10">
            </div>
            <div class="control-item">
                <label>
                    Petal Density <span class="slider-value" id="density-value">Medium</span>
                </label>
                <input type="range" id="petal-density" min="1" max="3" value="2" step="1">
            </div>
        </div>

        <div class="control-section">
            <h3>Blossom Colors</h3>
            <div class="color-options">
                <div class="color-option active" data-color="soft-pink" style="background: linear-gradient(135deg, #FFB6C1, #FFC0CB);"></div>
                <div class="color-option" data-color="deep-pink" style="background: linear-gradient(135deg, #FF69B4, #FF1493);"></div>
                <div class="color-option" data-color="white" style="background: linear-gradient(135deg, #FFFFFF, #F0F0F0);"></div>
                <div class="color-option" data-color="rainbow" style="background: linear-gradient(135deg, #FFB6C1, #DDA0DD, #B0C4DE);"></div>
            </div>
        </div>

        <div class="control-section">
            <h3>Atmosphere</h3>
            <div class="control-item">
                <label class="toggle-switch">
                    <span>Day/Night Mode</span>
                    <input type="checkbox" id="toggle-night" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="control-item">
                <label>
                    Bloom Intensity <span class="slider-value" id="bloom-value">50%</span>
                </label>
                <input type="range" id="bloom-intensity" min="0" max="100" value="50" step="5">
            </div>
        </div>

        <div class="control-section">
            <div class="action-buttons">
                <button class="btn btn-primary" id="play-pause">‚è∏ Pause</button>
                <button class="btn btn-secondary" id="fullscreen">‚õ∂ Fullscreen</button>
                <button class="btn btn-secondary" id="reset">‚Üª Reset</button>
            </div>
        </div>
    </div>

    <div id="performance-monitor">
        FPS: <span id="fps-counter">60</span> | Particles: <span id="particle-count">0</span>
    </div>

    <script>
        // Enhanced Cherry Blossom Garden Application
        class CherryBlossomGarden {
            constructor() {
                this.canvas = document.getElementById('garden-canvas');
                this.ctx = this.canvas.getContext('2d', { alpha: false });
                this.resizeCanvas();
                
                // Performance monitoring
                this.fpsCounter = document.getElementById('fps-counter');
                this.particleCount = document.getElementById('particle-count');
                this.lastTime = performance.now();
                this.frameCount = 0;
                this.fps = 60;
                
                // State management
                this.state = {
                    trees: true,
                    petals: true,
                    river: true,
                    path: true,
                    petalSpeed: 1.0,
                    waterSpeed: 1.0,
                    petalDensity: 2,
                    blossomColor: 'soft-pink',
                    isDay: true,
                    bloomIntensity: 0.5,
                    isPaused: false,
                    isFullscreen: false
                };
                
                // Animation state
                this.time = 0;
                this.petals = [];
                this.riverOffset = 0;
                this.pathGlowOffset = 0;
                
                // Enhanced features
                this.wind = {
                    strength: 0.5,
                    direction: 1,
                    changeTime: 0
                };
                
                this.stars = [];
                this.initializeStars();
                this.initializePetals();
                this.setupEventListeners();
                
                // Start animation after a brief loading period
                setTimeout(() => {
                    document.getElementById('loading-screen').classList.add('hidden');
                    this.animate();
                }, 1500);
            }
            
            resizeCanvas() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                this.initializeStars(); // Reinitialize stars on resize
            }
            
            initializeStars() {
                this.stars = [];
                const starCount = Math.min(200, Math.floor((this.canvas.width * this.canvas.height) / 2000));
                
                for (let i = 0; i < starCount; i++) {
                    this.stars.push({
                        x: Math.random() * this.canvas.width,
                        y: Math.random() * this.canvas.height * 0.5,
                        size: Math.random() * 1.5 + 0.5,
                        brightness: Math.random() * 0.8 + 0.2,
                        twinkleSpeed: Math.random() * 0.05 + 0.02,
                        twinkleOffset: Math.random() * Math.PI * 2
                    });
                }
            }
            
            initializePetals() {
                this.petals = [];
                const density = this.state.petalDensity === 1 ? 50 : this.state.petalDensity === 2 ? 100 : 150;
                for (let i = 0; i < density; i++) {
                    this.petals.push(this.createPetal());
                }
            }
            
            createPetal() {
                return {
                    x: Math.random() * this.canvas.width,
                    y: Math.random() * this.canvas.height - this.canvas.height,
                    size: Math.random() * 8 + 4,
                    speedY: Math.random() * 1.5 + 0.5,
                    speedX: Math.random() * 0.8 - 0.4,
                    rotation: Math.random() * Math.PI * 2,
                    rotationSpeed: Math.random() * 0.03 - 0.015,
                    opacity: Math.random() * 0.7 + 0.3,
                    swing: Math.random() * Math.PI * 2,
                    swingSpeed: Math.random() * 0.03 + 0.01,
                    sway: Math.random() * 0.5 - 0.25,
                    colorVariation: Math.random()
                };
            }
            
            getBlossomColors() {
                const colors = {
                    'soft-pink': {
                        tree: ['#FFB6C1', '#FFC0CB', '#FFE4E1'],
                        petal: ['#FFB6C1', '#FFC0CB', '#FADADD']
                    },
                    'deep-pink': {
                        tree: ['#FF69B4', '#FF1493', '#FF6B9D'],
                        petal: ['#FF69B4', '#FF1493', '#FF85A1']
                    },
                    'white': {
                        tree: ['#FFFFFF', '#F8F8FF', '#FFFAFA'],
                        petal: ['#FFFFFF', '#F5F5F5', '#FAFAFA']
                    },
                    'rainbow': {
                        tree: ['#FFB6C1', '#DDA0DD', '#B0C4DE', '#FFE4E1'],
                        petal: ['#FFB6C1', '#DDA0DD', '#B0C4DE', '#FADADD']
                    }
                };
                return colors[this.state.blossomColor];
            }
            
            drawBackground() {
                const gradient = this.ctx.createLinearGradient(0, 0, 0, this.canvas.height);
                
                if (this.state.isDay) {
                    gradient.addColorStop(0, '#6AB0E3');
                    gradient.addColorStop(0.4, '#87CEEB');
                    gradient.addColorStop(0.7, '#B0E0E6');
                    gradient.addColorStop(1, '#F0E68C');
                } else {
                    gradient.addColorStop(0, '#0F1A2F');
                    gradient.addColorStop(0.4, '#1A2B4A');
                    gradient.addColorStop(0.7, '#2C3E50');
                    gradient.addColorStop(1, '#34495E');
                }
                
                this.ctx.fillStyle = gradient;
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
            }
            
            drawStars() {
                if (this.state.isDay) return;
                
                this.ctx.fillStyle = 'white';
                this.stars.forEach(star => {
                    const twinkle = Math.sin(this.time * star.twinkleSpeed + star.twinkleOffset) * 0.3 + 0.7;
                    this.ctx.globalAlpha = star.brightness * twinkle;
                    this.ctx.beginPath();
                    this.ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                    this.ctx.fill();
                });
                this.ctx.globalAlpha = 1;
            }
            
            drawMountains() {
                const mountainColor = this.state.isDay ? 'rgba(80, 100, 120, 0.7)' : 'rgba(30, 40, 60, 0.8)';
                
                // Far mountains
                this.ctx.fillStyle = mountainColor;
                this.ctx.beginPath();
                this.ctx.moveTo(0, this.canvas.height * 0.5);
                
                // Create multiple mountain peaks
                const peaks = 8;
                for (let i = 0; i <= peaks; i++) {
                    const x = (i / peaks) * this.canvas.width;
                    const heightVariation = Math.sin(i * 0.7) * 0.2 + 0.8;
                    const y = this.canvas.height * (0.35 - Math.sin(i * 0.5) * 0.05) * heightVariation;
                    this.ctx.lineTo(x, y);
                }
                
                this.ctx.lineTo(this.canvas.width, this.canvas.height * 0.5);
                this.ctx.lineTo(this.canvas.width, this.canvas.height);
                this.ctx.lineTo(0, this.canvas.height);
                this.ctx.closePath();
                this.ctx.fill();
            }
            
            drawGrass() {
                const grassGradient = this.ctx.createLinearGradient(0, this.canvas.height * 0.5, 0, this.canvas.height);
                
                if (this.state.isDay) {
                    grassGradient.addColorStop(0, '#7CCD7C');
                    grassGradient.addColorStop(0.5, '#66CDAA');
                    grassGradient.addColorStop(1, '#228B22');
                } else {
                    grassGradient.addColorStop(0, '#2F4F2F');
                    grassGradient.addColorStop(0.5, '#2E4F2E');
                    grassGradient.addColorStop(1, '#1C3B1C');
                }
                
                this.ctx.fillStyle = grassGradient;
                this.ctx.fillRect(0, this.canvas.height * 0.5, this.canvas.width, this.canvas.height * 0.5);
                
                // Add some grass details
                this.ctx.strokeStyle = this.state.isDay ? 'rgba(50, 120, 50, 0.3)' : 'rgba(30, 70, 30, 0.4)';
                this.ctx.lineWidth = 1;
                
                for (let i = 0; i < 100; i++) {
                    const x = Math.random() * this.canvas.width;
                    const height = Math.random() * 20 + 5;
                    this.ctx.beginPath();
                    this.ctx.moveTo(x, this.canvas.height * 0.5);
                    this.ctx.lineTo(x + (Math.random() - 0.5) * 10, this.canvas.height * 0.5 - height);
                    this.ctx.stroke();
                }
            }
            
            drawRiver() {
                if (!this.state.river) return;
                
                const riverY = this.canvas.height * 0.6;
                const riverHeight = this.canvas.height * 0.25;
                
                // River base with more natural shape
                const riverGradient = this.ctx.createLinearGradient(0, riverY, 0, riverY + riverHeight);
                if (this.state.isDay) {
                    riverGradient.addColorStop(0, 'rgba(100, 180, 255, 0.7)');
                    riverGradient.addColorStop(0.5, 'rgba(70, 150, 230, 0.8)');
                    riverGradient.addColorStop(1, 'rgba(50, 130, 210, 0.9)');
                } else {
                    riverGradient.addColorStop(0, 'rgba(30, 60, 120, 0.8)');
                    riverGradient.addColorStop(0.5, 'rgba(20, 40, 90, 0.9)');
                    riverGradient.addColorStop(1, 'rgba(10, 30, 70, 0.9)');
                }
                
                this.ctx.fillStyle = riverGradient;
                this.ctx.beginPath();
                this.ctx.moveTo(0, riverY);
                
                // Create a more natural, winding river
                for (let x = 0; x <= this.canvas.width; x += 10) {
                    const wave = Math.sin((x * 0.005) + (this.riverOffset * 0.003)) * 40 +
                                Math.sin((x * 0.01) + (this.riverOffset * 0.002)) * 20;
                    this.ctx.lineTo(x, riverY + wave);
                }
                
                for (let x = this.canvas.width; x >= 0; x -= 10) {
                    const wave = Math.sin((x * 0.005) + (this.riverOffset * 0.003)) * 40 +
                                Math.sin((x * 0.01) + (this.riverOffset * 0.002)) * 20;
                    this.ctx.lineTo(x, riverY + riverHeight + wave);
                }
                
                this.ctx.closePath();
                this.ctx.fill();
                
                // Water shimmer effects
                this.ctx.globalAlpha = 0.4;
                for (let i = 0; i < 15; i++) {
                    const shimmerX = (this.riverOffset * 2 + i * 80) % this.canvas.width;
                    const shimmerY = riverY + Math.random() * riverHeight;
                    const shimmerSize = Math.random() * 40 + 20;
                    
                    const shimmerGradient = this.ctx.createRadialGradient(
                        shimmerX, shimmerY, 0,
                        shimmerX, shimmerY, shimmerSize
                    );
                    shimmerGradient.addColorStop(0, 'rgba(255, 255, 255, 0.8)');
                    shimmerGradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
                    
                    this.ctx.fillStyle = shimmerGradient;
                    this.ctx.fillRect(shimmerX - shimmerSize, shimmerY - shimmerSize, shimmerSize * 2, shimmerSize * 2);
                }
                this.ctx.globalAlpha = 1;
            }
            
            drawPath() {
                if (!this.state.path) return;
                
                const pathY = this.canvas.height * 0.7;
                const pathWidth = 150;
                
                // Path base with gradient
                const pathGradient = this.ctx.createLinearGradient(0, pathY, 0, this.canvas.height);
                pathGradient.addColorStop(0, this.state.isDay ? 'rgba(160, 150, 140, 0.8)' : 'rgba(100, 90, 80, 0.8)');
                pathGradient.addColorStop(1, this.state.isDay ? 'rgba(120, 110, 100, 0.9)' : 'rgba(80, 70, 60, 0.9)');
                
                this.ctx.fillStyle = pathGradient;
                this.ctx.beginPath();
                
                for (let y = pathY; y < this.canvas.height; y += 10) {
                    const progress = (y - pathY) / (this.canvas.height - pathY);
                    const width = pathWidth * (1 + progress * 0.5);
                    const centerX = this.canvas.width * 0.3 + Math.sin(y * 0.005) * 80;
                    
                    this.ctx.moveTo(centerX - width / 2, y);
                    this.ctx.lineTo(centerX + width / 2, y);
                }
                this.ctx.fill();
                
                // Stones on path with more variety
                this.ctx.globalAlpha = 0.9;
                for (let i = 0; i < 20; i++) {
                    const stoneY = pathY + (i * (this.canvas.height - pathY) / 20);
                    const progress = (stoneY - pathY) / (this.canvas.height - pathY);
                    const centerX = this.canvas.width * 0.3 + Math.sin(stoneY * 0.005) * 80;
                    const stoneX = centerX + (Math.random() - 0.5) * pathWidth * (1 + progress * 0.5) * 0.7;
                    const stoneSize = 12 + Math.random() * 15 + progress * 15;
                    const stoneColor = this.state.isDay ? 
                        `rgba(${150 + Math.random() * 50}, ${140 + Math.random() * 40}, ${130 + Math.random() * 30}, 0.9)` :
                        `rgba(${90 + Math.random() * 30}, ${80 + Math.random() * 20}, ${70 + Math.random() * 20}, 0.9)`;
                    
                    // Stone glow effect
                    const glowIntensity = Math.sin(this.pathGlowOffset + i * 0.5) * 0.5 + 0.5;
                    if (this.state.bloomIntensity > 0 && glowIntensity > 0.7) {
                        const glowGradient = this.ctx.createRadialGradient(
                            stoneX, stoneY, 0,
                            stoneX, stoneY, stoneSize * 2.5
                        );
                        glowGradient.addColorStop(0, `rgba(255, 255, 220, ${this.state.bloomIntensity * 0.4})`);
                        glowGradient.addColorStop(1, 'rgba(255, 255, 220, 0)');
                        this.ctx.fillStyle = glowGradient;
                        this.ctx.fillRect(stoneX - stoneSize * 2.5, stoneY - stoneSize * 2.5, stoneSize * 5, stoneSize * 5);
                    }
                    
                    this.ctx.fillStyle = stoneColor;
                    this.ctx.beginPath();
                    this.ctx.arc(stoneX, stoneY, stoneSize, 0, Math.PI * 2);
                    this.ctx.fill();
                    
                    // Add some stone texture
                    this.ctx.strokeStyle = this.state.isDay ? 'rgba(100, 90, 80, 0.3)' : 'rgba(60, 50, 40, 0.4)';
                    this.ctx.lineWidth = 1;
                    this.ctx.beginPath();
                    this.ctx.arc(stoneX, stoneY, stoneSize * 0.7, 0, Math.PI * 1.5);
                    this.ctx.stroke();
                }
                this.ctx.globalAlpha = 1;
            }
            
            drawTree(x, y, trunkHeight, branchSpread, colors) {
                // Trunk with texture
                this.ctx.fillStyle = this.state.isDay ? '#5D4037' : '#3E2723';
                this.ctx.fillRect(x - 18, y, 36, trunkHeight);
                
                // Trunk texture
                this.ctx.strokeStyle = this.state.isDay ? '#4A3529' : '#2A1D17';
                this.ctx.lineWidth = 2;
                for (let i = 0; i < 5; i++) {
                    const lineY = y + (i * trunkHeight / 5);
                    this.ctx.beginPath();
                    this.ctx.moveTo(x - 15, lineY);
                    this.ctx.lineTo(x + 15, lineY);
                    this.ctx.stroke();
                }
                
                // Main branches with wind effect
                this.ctx.strokeStyle = this.state.isDay ? '#5D4037' : '#3E2723';
                this.ctx.lineWidth = 10;
                this.ctx.lineCap = 'round';
                
                const windEffect = Math.sin(this.time * 0.5) * this.wind.strength * 0.1;
                
                for (let i = 0; i < 6; i++) {
                    const angle = (Math.PI / 5) * (i - 2.5) + windEffect;
                    const branchLength = branchSpread * (0.7 + Math.random() * 0.3);
                    const startY = y + trunkHeight * (0.2 + i * 0.15);
                    
                    this.ctx.beginPath();
                    this.ctx.moveTo(x, startY);
                    this.ctx.lineTo(
                        x + Math.cos(angle) * branchLength,
                        startY - Math.sin(angle) * branchLength
                    );
                    this.ctx.stroke();
                    
                    // Secondary branches
                    if (i > 1) {
                        for (let j = 0; j < 3; j++) {
                            const subAngle = angle + (Math.random() - 0.5) * 0.7;
                            const subLength = branchLength * 0.5;
                            const subStart = 0.3 + Math.random() * 0.5;
                            
                            this.ctx.beginPath();
                            this.ctx.moveTo(
                                x + Math.cos(angle) * branchLength * subStart,
                                startY - Math.sin(angle) * branchLength * subStart
                            );
                            this.ctx.lineTo(
                                x + Math.cos(angle) * branchLength * subStart + Math.cos(subAngle) * subLength,
                                startY - Math.sin(angle) * branchLength * subStart - Math.sin(subAngle) * subLength
                            );
                            this.ctx.stroke();
                        }
                    }
                }
                
                // Blossom clusters with more natural distribution
                for (let i = 0; i < 50; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const radius = Math.random() * branchSpread * 0.8;
                    const clusterX = x + Math.cos(angle) * radius * (0.5 + Math.random() * 0.5);
                    const clusterY = y + trunkHeight * 0.2 - Math.sin(Math.abs(angle)) * radius * 0.7;
                    
                    const blossomSize = Math.random() * 25 + 15;
                    const colorIndex = Math.floor(Math.random() * colors.length);
                    const color = colors[colorIndex];
                    const alpha = 0.6 + Math.random() * 0.4;
                    
                    // Bloom glow
                    if (this.state.bloomIntensity > 0) {
                        const glowGradient = this.ctx.createRadialGradient(
                            clusterX, clusterY, 0,
                            clusterX, clusterY, blossomSize * 2.5
                        );
                        const glowAlpha = this.state.bloomIntensity * 0.6;
                        glowGradient.addColorStop(0, `${color}${Math.floor(glowAlpha * 255).toString(16).padStart(2, '0')}`);
                        glowGradient.addColorStop(1, `${color}00`);
                        this.ctx.fillStyle = glowGradient;
                        this.ctx.fillRect(clusterX - blossomSize * 2.5, clusterY - blossomSize * 2.5, blossomSize * 5, blossomSize * 5);
                    }
                    
                    this.ctx.fillStyle = color;
                    this.ctx.globalAlpha = alpha;
                    this.ctx.beginPath();
                    this.ctx.arc(clusterX, clusterY, blossomSize, 0, Math.PI * 2);
                    this.ctx.fill();
                    
                    // Petal details
                    this.ctx.strokeStyle = this.state.isDay ? 'rgba(255, 255, 255, 0.3)' : 'rgba(255, 255, 255, 0.2)';
                    this.ctx.lineWidth = 1;
                    this.ctx.beginPath();
                    this.ctx.arc(clusterX, clusterY, blossomSize * 0.7, 0, Math.PI * 1.5);
                    this.ctx.stroke();
                }
                this.ctx.globalAlpha = 1;
            }
            
            drawTrees() {
                if (!this.state.trees) return;
                
                const colors = this.getBlossomColors().tree;
                
                // Background trees
                this.ctx.globalAlpha = 0.6;
                this.drawTree(this.canvas.width * 0.15, this.canvas.height * 0.45, 100, 120, colors);
                this.drawTree(this.canvas.width * 0.85, this.canvas.height * 0.48, 90, 110, colors);
                this.ctx.globalAlpha = 1;
                
                // Foreground trees
                this.drawTree(this.canvas.width * 0.1, this.canvas.height * 0.3, 180, 220, colors);
                this.drawTree(this.canvas.width * 0.7, this.canvas.height * 0.35, 170, 200, colors);
                this.drawTree(this.canvas.width * 0.9, this.canvas.height * 0.25, 190, 230, colors);
            }
            
            updateWind() {
                // Change wind direction occasionally
                this.wind.changeTime += 0.01;
                if (this.wind.changeTime > 10) {
                    this.wind.direction = Math.random() > 0.5 ? 1 : -1;
                    this.wind.strength = 0.3 + Math.random() * 0.7;
                    this.wind.changeTime = 0;
                }
                
                // Apply slight wind variation
                this.wind.strength += (Math.random() - 0.5) * 0.05;
                this.wind.strength = Math.max(0.2, Math.min(1, this.wind.strength));
            }
            
            updatePetals() {
                if (!this.state.petals) return;
                
                this.updateWind();
                
                this.petals.forEach(petal => {
                    // Apply gravity
                    petal.speedY += 0.01;
                    
                    // Apply wind effect
                    const windEffect = Math.sin(this.time * 2 + petal.x * 0.01) * this.wind.strength * 0.5 * this.wind.direction;
                    petal.x += (petal.speedX + windEffect) * this.state.petalSpeed;
                    petal.y += petal.speedY * this.state.petalSpeed;
                    
                    // Apply swinging motion
                    petal.x += Math.sin(petal.swing) * 2;
                    petal.swing += petal.swingSpeed;
                    
                    // Apply rotation
                    petal.rotation += petal.rotationSpeed;
                    
                    // Apply slight sway
                    petal.x += petal.sway * this.wind.strength;
                    
                    // Reset petals that fall off screen
                    if (petal.y > this.canvas.height + 50) {
                        Object.assign(petal, this.createPetal());
                        petal.y = -20;
                    }
                    if (petal.x < -50) petal.x = this.canvas.width + 50;
                    if (petal.x > this.canvas.width + 50) petal.x = -50;
                });
            }
            
            drawPetals() {
                if (!this.state.petals) return;
                
                const colors = this.getBlossomColors().petal;
                
                this.petals.forEach(petal => {
                    this.ctx.save();
                    this.ctx.translate(petal.x, petal.y);
                    this.ctx.rotate(petal.rotation);
                    this.ctx.globalAlpha = petal.opacity;
                    
                    // Choose color with some variation
                    const colorIndex = Math.floor(petal.colorVariation * colors.length);
                    const color = colors[colorIndex];
                    this.ctx.fillStyle = color;
                    
                    // Draw petal shape with more detail
                    this.ctx.beginPath();
                    this.ctx.ellipse(0, 0, petal.size, petal.size * 1.6, 0, 0, Math.PI * 2);
                    this.ctx.fill();
                    
                    // Add petal details
                    this.ctx.strokeStyle = this.state.isDay ? 'rgba(255, 255, 255, 0.4)' : 'rgba(255, 255, 255, 0.2)';
                    this.ctx.lineWidth = 1;
                    this.ctx.beginPath();
                    this.ctx.moveTo(0, -petal.size * 1.2);
                    this.ctx.lineTo(0, petal.size * 1.2);
                    this.ctx.stroke();
                    
                    this.ctx.restore();
                });
                
                this.ctx.globalAlpha = 1;
            }
            
            updatePerformanceMonitor() {
                this.frameCount++;
                const currentTime = performance.now();
                
                if (currentTime >= this.lastTime + 1000) {
                    this.fps = Math.round((this.frameCount * 1000) / (currentTime - this.lastTime));
                    this.fpsCounter.textContent = this.fps;
                    this.particleCount.textContent = this.petals.length;
                    
                    this.frameCount = 0;
                    this.lastTime = currentTime;
                    
                    // Show performance monitor if FPS drops below 50
                    document.getElementById('performance-monitor').style.display = this.fps < 50 ? 'block' : 'none';
                }
            }
            
            animate() {
                if (!this.state.isPaused) {
                    this.time += 0.01;
                    this.riverOffset += 1.5 * this.state.waterSpeed;
                    this.pathGlowOffset += 0.05;
                    
                    this.drawBackground();
                    this.drawStars();
                    this.drawMountains();
                    this.drawGrass();
                    this.drawRiver();
                    this.drawPath();
                    this.drawTrees();
                    this.updatePetals();
                    this.drawPetals();
                    
                    this.updatePerformanceMonitor();
                }
                
                requestAnimationFrame(() => this.animate());
            }
            
            setupEventListeners() {
                // Welcome screen
                document.getElementById('enter-garden').addEventListener('click', () => {
                    document.getElementById('welcome-screen').classList.add('hidden');
                });
                
                // Toggle panel
                document.getElementById('toggle-panel').addEventListener('click', () => {
                    document.getElementById('control-panel').classList.toggle('hidden');
                });
                
                // Scene elements
                document.getElementById('toggle-trees').addEventListener('change', (e) => {
                    this.state.trees = e.target.checked;
                });
                
                document.getElementById('toggle-petals').addEventListener('change', (e) => {
                    this.state.petals = e.target.checked;
                });
                
                document.getElementById('toggle-river').addEventListener('change', (e) => {
                    this.state.river = e.target.checked;
                });
                
                document.getElementById('toggle-path').addEventListener('change', (e) => {
                    this.state.path = e.target.checked;
                });
                
                // Petal speed
                document.getElementById('petal-speed').addEventListener('input', (e) => {
                    this.state.petalSpeed = e.target.value / 100;
                    document.getElementById('petal-speed-value').textContent = `${this.state.petalSpeed.toFixed(1)}x`;
                });
                
                // Water speed
                document.getElementById('water-speed').addEventListener('input', (e) => {
                    this.state.waterSpeed = e.target.value / 100;
                    document.getElementById('water-speed-value').textContent = `${this.state.waterSpeed.toFixed(1)}x`;
                });
                
                // Petal density
                document.getElementById('petal-density').addEventListener('input', (e) => {
                    this.state.petalDensity = parseInt(e.target.value);
                    const labels = ['Low', 'Medium', 'High'];
                    document.getElementById('density-value').textContent = labels[this.state.petalDensity - 1];
                    this.initializePetals();
                });
                
                // Color options
                document.querySelectorAll('.color-option').forEach(option => {
                    option.addEventListener('click', () => {
                        document.querySelectorAll('.color-option').forEach(o => o.classList.remove('active'));
                        option.classList.add('active');
                        this.state.blossomColor = option.dataset.color;
                    });
                });
                
                // Day/Night toggle
                document.getElementById('toggle-night').addEventListener('change', (e) => {
                    this.state.isDay = e.target.checked;
                });
                
                // Bloom intensity
                document.getElementById('bloom-intensity').addEventListener('input', (e) => {
                    this.state.bloomIntensity = e.target.value / 100;
                    document.getElementById('bloom-value').textContent = `${e.target.value}%`;
                });
                
                // Play/Pause
                document.getElementById('play-pause').addEventListener('click', () => {
                    this.state.isPaused = !this.state.isPaused;
                    const btn = document.getElementById('play-pause');
                    btn.textContent = this.state.isPaused ? '‚ñ∂ Play' : '‚è∏ Pause';
                });
                
                // Fullscreen
                document.getElementById('fullscreen').addEventListener('click', () => {
                    if (!document.fullscreenElement) {
                        document.documentElement.requestFullscreen();
                        this.state.isFullscreen = true;
                    } else {
                        document.exitFullscreen();
                        this.state.isFullscreen = false;
                    }
                });
                
                // Reset
                document.getElementById('reset').addEventListener('click', () => {
                    this.state = {
                        trees: true,
                        petals: true,
                        river: true,
                        path: true,
                        petalSpeed: 1.0,
                        waterSpeed: 1.0,
                        petalDensity: 2,
                        blossomColor: 'soft-pink',
                        isDay: true,
                        bloomIntensity: 0.5,
                        isPaused: false,
                        isFullscreen: this.state.isFullscreen
                    };
                    
                    // Reset UI
                    document.getElementById('toggle-trees').checked = true;
                    document.getElementById('toggle-petals').checked = true;
                    document.getElementById('toggle-river').checked = true;
                    document.getElementById('toggle-path').checked = true;
                    document.getElementById('toggle-night').checked = true;
                    document.getElementById('petal-speed').value = 100;
                    document.getElementById('water-speed').value = 100;
                    document.getElementById('petal-density').value = 2;
                    document.getElementById('bloom-intensity').value = 50;
                    document.getElementById('petal-speed-value').textContent = '1.0x';
                    document.getElementById('water-speed-value').textContent = '1.0x';
                    document.getElementById('density-value').textContent = 'Medium';
                    document.getElementById('bloom-value').textContent = '50%';
                    document.getElementById('play-pause').textContent = '‚è∏ Pause';
                    
                    document.querySelectorAll('.color-option').forEach(o => o.classList.remove('active'));
                    document.querySelector('[data-color="soft-pink"]').classList.add('active');
                    
                    this.initializePetals();
                });
                
                // Window resize
                window.addEventListener('resize', () => {
                    this.resizeCanvas();
                });
            }
        }

        // Initialize the garden when the page loads
        window.addEventListener('DOMContentLoaded', () => {
            new CherryBlossomGarden();
        });
    </script>
</body>
</html>