<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Midnight City - Calming City View</title>
    <style>
        :root {
            --color-white: rgba(255, 255, 255, 1);
            --color-black: rgba(0, 0, 0, 1);
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-gray-400: rgba(119, 124, 124, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-brown-600: rgba(94, 82, 64, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-teal-300: rgba(50, 184, 198, 1);
            --color-teal-400: rgba(45, 166, 178, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-teal-700: rgba(26, 104, 115, 1);
            --color-teal-800: rgba(41, 150, 161, 1);
            --color-red-400: rgba(255, 84, 89, 1);
            --color-red-500: rgba(192, 21, 47, 1);
            --color-orange-400: rgba(230, 129, 97, 1);
            --color-orange-500: rgba(168, 75, 47, 1);
            --color-brown-600-rgb: 94, 82, 64;
            --color-teal-500-rgb: 33, 128, 141;
            --color-slate-900-rgb: 19, 52, 59;
            --color-slate-500-rgb: 98, 108, 113;
            --color-red-500-rgb: 192, 21, 47;
            --color-red-400-rgb: 255, 84, 89;
            --color-orange-500-rgb: 168, 75, 47;
            --color-orange-400-rgb: 230, 129, 97;
            --color-background: var(--color-cream-50);
            --color-surface: var(--color-cream-100);
            --color-text: var(--color-slate-900);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-primary-active: var(--color-teal-700);
            --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
            --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
            --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
            --color-border: rgba(var(--color-brown-600-rgb), 0.2);
            --color-btn-primary-text: var(--color-cream-50);
            --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --font-size-xs: 11px;
            --font-size-sm: 12px;
            --font-size-base: 14px;
            --font-size-md: 14px;
            --font-size-lg: 16px;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 550;
            --space-4: 4px;
            --space-8: 8px;
            --space-12: 12px;
            --space-16: 16px;
            --space-20: 20px;
            --radius-base: 8px;
            --radius-lg: 12px;
            --duration-normal: 250ms;
            --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family-base);
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            background: #0a0e27;
        }

        #cityCanvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        .control-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(20, 20, 30, 0.85);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-lg);
            padding: var(--space-20);
            color: #e0e0e0;
            font-size: var(--font-size-base);
            max-width: 280px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            transition: transform var(--duration-normal) var(--ease-standard), opacity var(--duration-normal) var(--ease-standard);
            z-index: 1000;
        }

        .control-panel.collapsed {
            transform: translateX(calc(100% + 20px));
            opacity: 0;
            pointer-events: none;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-16);
            padding-bottom: var(--space-12);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: #fff;
        }

        .collapse-btn {
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
            font-size: 20px;
            padding: var(--space-4);
            opacity: 0.7;
            transition: opacity var(--duration-normal);
        }

        .collapse-btn:hover {
            opacity: 1;
        }

        .expand-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(20, 20, 30, 0.85);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            transition: all var(--duration-normal) var(--ease-standard);
            z-index: 999;
            display: none;
        }

        .expand-btn.visible {
            display: block;
        }

        .expand-btn:hover {
            transform: scale(1.1);
            background: rgba(30, 30, 40, 0.9);
        }

        .control-section {
            margin-bottom: var(--space-20);
        }

        .section-title {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--space-12);
        }

        .scenery-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-8);
        }

        .scenery-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-base);
            padding: var(--space-12);
            color: #e0e0e0;
            cursor: pointer;
            transition: all var(--duration-normal) var(--ease-standard);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            text-align: center;
        }

        .scenery-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .scenery-btn.active {
            background: rgba(50, 184, 198, 0.2);
            border-color: rgba(50, 184, 198, 0.5);
            color: #32b8c6;
        }

        .toggle-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-8) 0;
        }

        .toggle-label {
            font-size: var(--font-size-sm);
            color: #d0d0d0;
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: background var(--duration-normal);
        }

        .toggle-switch.active {
            background: rgba(50, 184, 198, 0.5);
        }

        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 18px;
            height: 18px;
            background: #fff;
            border-radius: 50%;
            transition: transform var(--duration-normal) var(--ease-standard);
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(20px);
        }

        .slider-container {
            margin-top: var(--space-8);
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            font-size: var(--font-size-sm);
            color: #d0d0d0;
            margin-bottom: var(--space-8);
        }

        .slider {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #32b8c6;
            border-radius: 50%;
            cursor: pointer;
            transition: all var(--duration-normal);
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #32b8c6;
            border-radius: 50%;
            cursor: pointer;
            border: none;
            transition: all var(--duration-normal);
        }

        .slider::-moz-range-thumb:hover {
            transform: scale(1.2);
        }

        @font-face {
            font-family: 'FKGroteskNeue';
            src: url('https://r2cdn.perplexity.ai/fonts/FKGroteskNeue.woff2') format('woff2');
        }
    </style>
</head>
<body>
    <canvas id="cityCanvas"></canvas>
    
    <button class="expand-btn" id="expandBtn" onclick="togglePanel()">☰</button>
    
    <div class="control-panel" id="controlPanel">
        <div class="panel-header">
            <div class="panel-title">City Controls</div>
            <button class="collapse-btn" onclick="togglePanel()">×</button>
        </div>

        <div class="control-section">
            <div class="section-title">Scenery</div>
            <div class="scenery-grid">
                <button class="scenery-btn active" onclick="setScenery('midnight')">Midnight City</button>
                <button class="scenery-btn" onclick="setScenery('vibrant')">Vibrant Downtown</button>
                <button class="scenery-btn" onclick="setScenery('rainy')">Rainy Night</button>
                <button class="scenery-btn" onclick="setScenery('newyear')">New Year's Eve</button>
            </div>
        </div>

        <div class="control-section">
            <div class="section-title">Effects</div>
            <div class="toggle-item">
                <div class="toggle-label">Window Lights</div>
                <div class="toggle-switch active" id="toggleWindows" onclick="toggleEffect('windows')"><div class="toggle-slider"></div></div>
            </div>
            <div class="toggle-item">
                <div class="toggle-label">Traffic</div>
                <div class="toggle-switch active" id="toggleTraffic" onclick="toggleEffect('traffic')"><div class="toggle-slider"></div></div>
            </div>
            <div class="toggle-item">
                <div class="toggle-label">Fireworks</div>
                <div class="toggle-switch active" id="toggleFireworks" onclick="toggleEffect('fireworks')"><div class="toggle-slider"></div></div>
            </div>
            <div class="toggle-item">
                <div class="toggle-label">Planes</div>
                <div class="toggle-switch active" id="togglePlanes" onclick="toggleEffect('planes')"><div class="toggle-slider"></div></div>
            </div>
            <div class="toggle-item">
                <div class="toggle-label">Clouds</div>
                <div class="toggle-switch active" id="toggleClouds" onclick="toggleEffect('clouds')"><div class="toggle-slider"></div></div>
            </div>
            <div class="toggle-item">
                <div class="toggle-label">Rain</div>
                <div class="toggle-switch" id="toggleRain" onclick="toggleEffect('rain')"><div class="toggle-slider"></div></div>
            </div>
        </div>

        <div class="control-section">
            <div class="section-title">Speed</div>
            <div class="slider-container">
                <div class="slider-label">
                    <span>Animation Speed</span>
                    <span id="speedValue">1.0x</span>
                </div>
                <input type="range" min="0.5" max="3" step="0.1" value="1" class="slider" id="speedSlider" oninput="updateSpeed(this.value)">
            </div>
        </div>

        <div class="control-section">
            <div class="toggle-item">
                <div class="toggle-label">Ambient Sound</div>
                <div class="toggle-switch" id="toggleSound" onclick="toggleEffect('sound')"><div class="toggle-slider"></div></div>
            </div>
        </div>
    </div>

    <script>
        // Canvas setup
const canvas = document.getElementById('cityCanvas');
const ctx = canvas.getContext('2d');

let width = canvas.width = window.innerWidth;
let height = canvas.height = window.innerHeight;

window.addEventListener('resize', () => {
    width = canvas.width = window.innerWidth;
    height = canvas.height = window.innerHeight;
    initBuildings();
    initClouds();
});

// State management
const state = {
    currentScenery: 'midnight',
    effects: {
        windows: true,
        traffic: true,
        fireworks: true,
        planes: true,
        clouds: true,
        rain: false,
        sound: false
    },
    speed: 1.0,
    settings: {
        windowDensity: 0.3,
        trafficDensity: 0.2,
        fireworksFrequency: 0.05,
        planeFrequency: 0.1,
        overallBrightness: 0.7,
        rainEnabled: false
    }
};

// Scenery presets
const sceneryPresets = {
    midnight: {
        windowDensity: 0.3,
        trafficDensity: 0.2,
        fireworksFrequency: 0.05,
        planeFrequency: 0.1,
        overallBrightness: 0.7,
        rainEnabled: false
    },
    vibrant: {
        windowDensity: 0.8,
        trafficDensity: 0.6,
        fireworksFrequency: 0.15,
        planeFrequency: 0.2,
        overallBrightness: 1.0,
        rainEnabled: false
    },
    rainy: {
        windowDensity: 0.5,
        trafficDensity: 0.3,
        fireworksFrequency: 0.02,
        planeFrequency: 0.05,
        overallBrightness: 0.5,
        rainEnabled: true
    },
    newyear: {
        windowDensity: 1.0,
        trafficDensity: 0.4,
        fireworksFrequency: 0.4,
        planeFrequency: 0.15,
        overallBrightness: 1.0,
        rainEnabled: false
    }
};

// Color palettes
const colors = {
    sky: ['#0a0e27', '#1a1b4b', '#2d1b3d', '#3d2438'],
    buildings: ['#0d0d1a', '#1a1a2e'],
    window: '#ffebb3',
    street: '#ffd699',
    carHeadlight: '#ffffff',
    carTaillight: '#ff4444',
    fireworks: ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f7dc6f', '#bb8fce', '#85c1e2']
};

// Buildings
let buildings = [];

function initBuildings() {
    buildings = [];
    const numBuildings = Math.floor(width / 60) + 10;
    
    for (let i = 0; i < numBuildings; i++) {
        const w = 40 + Math.random() * 80;
        const h = 100 + Math.random() * 300;
        const x = i * (width / numBuildings) - 20 + Math.random() * 40;
        const y = height - h - 50;
        const layer = Math.random() < 0.3 ? 'back' : (Math.random() < 0.5 ? 'mid' : 'front');
        
        const windows = [];
        const rows = Math.floor(h / 25);
        const cols = Math.floor(w / 15);
        
        for (let r = 0; r < rows; r++) {
            for (let c = 0; c < cols; c++) {
                if (Math.random() < 0.7) {
                    windows.push({
                        x: x + c * (w / cols) + 5,
                        y: y + r * (h / rows) + 5,
                        width: (w / cols) - 5,
                        height: (h / rows) - 8,
                        on: Math.random() < state.settings.windowDensity,
                        nextFlicker: Date.now() + Math.random() * 5000 + 2000
                    });
                }
            }
        }
        
        buildings.push({ x, y, w, h, layer, windows, color: colors.buildings[Math.floor(Math.random() * colors.buildings.length)] });
    }
    
    buildings.sort((a, b) => {
        const layerOrder = { back: 0, mid: 1, front: 2 };
        return layerOrder[a.layer] - layerOrder[b.layer];
    });
}

// Stars
const stars = [];
for (let i = 0; i < 200; i++) {
    stars.push({
        x: Math.random() * width,
        y: Math.random() * height * 0.6,
        radius: Math.random() * 1.5,
        opacity: Math.random() * 0.8 + 0.2,
        twinkleSpeed: Math.random() * 0.02 + 0.01
    });
}

// Moon
const moon = {
    x: width * 0.8,
    y: height * 0.15,
    radius: 40
};

// Clouds
let clouds = [];

function initClouds() {
    clouds = [];
    for (let i = 0; i < 8; i++) {
        clouds.push({
            x: Math.random() * width,
            y: Math.random() * height * 0.4,
            width: 100 + Math.random() * 150,
            height: 40 + Math.random() * 60,
            speed: 0.1 + Math.random() * 0.3,
            opacity: 0.1 + Math.random() * 0.2
        });
    }
}

initClouds();

// Traffic
const cars = [];

function createCar() {
    if (Math.random() < state.settings.trafficDensity * 0.02 * state.speed) {
        const direction = Math.random() < 0.5 ? 1 : -1;
        cars.push({
            x: direction > 0 ? -20 : width + 20,
            y: height - 40 - Math.random() * 10,
            width: 15 + Math.random() * 10,
            height: 8,
            speed: (2 + Math.random() * 2) * direction,
            color: direction > 0 ? colors.carHeadlight : colors.carTaillight
        });
    }
}

// Fireworks
const fireworks = [];
const particles = [];

function createFirework() {
    if (Math.random() < state.settings.fireworksFrequency * 0.01 * state.speed) {
        fireworks.push({
            x: width * 0.2 + Math.random() * width * 0.6,
            y: height,
            targetY: height * 0.2 + Math.random() * height * 0.3,
            speed: 3 + Math.random() * 2,
            color: colors.fireworks[Math.floor(Math.random() * colors.fireworks.length)]
        });
    }
}

function explodeFirework(fw) {
    const particleCount = 30 + Math.floor(Math.random() * 30);
    for (let i = 0; i < particleCount; i++) {
        const angle = (Math.PI * 2 * i) / particleCount;
        const speed = 1 + Math.random() * 3;
        particles.push({
            x: fw.x,
            y: fw.targetY,
            vx: Math.cos(angle) * speed,
            vy: Math.sin(angle) * speed,
            color: fw.color,
            life: 1.0,
            decay: 0.01 + Math.random() * 0.01,
            size: 2 + Math.random() * 2
        });
    }
}

// Planes
const planes = [];

function createPlane() {
    if (Math.random() < state.settings.planeFrequency * 0.001 * state.speed) {
        const direction = Math.random() < 0.5 ? 1 : -1;
        planes.push({
            x: direction > 0 ? -50 : width + 50,
            y: height * 0.15 + Math.random() * height * 0.25,
            speed: (0.5 + Math.random() * 0.5) * direction,
            blinkPhase: Math.random() * Math.PI * 2,
            size: 3 + Math.random() * 2
        });
    }
}

// Rain
const raindrops = [];

function createRain() {
    if (state.settings.rainEnabled && Math.random() < 0.3) {
        raindrops.push({
            x: Math.random() * width,
            y: -10,
            speed: 8 + Math.random() * 4,
            length: 10 + Math.random() * 10,
            opacity: 0.3 + Math.random() * 0.3
        });
    }
}

// Audio context for ambient sound
let audioContext = null;
let ambientOscillator = null;
let gainNode = null;

function startAmbientSound() {
    if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
    
    if (ambientOscillator) {
        return;
    }
    
    ambientOscillator = audioContext.createOscillator();
    gainNode = audioContext.createGain();
    
    ambientOscillator.type = 'sine';
    ambientOscillator.frequency.setValueAtTime(100, audioContext.currentTime);
    gainNode.gain.setValueAtTime(0.02, audioContext.currentTime);
    
    ambientOscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    ambientOscillator.start();
    
    // Add subtle frequency modulation
    setInterval(() => {
        if (ambientOscillator && state.effects.sound) {
            const freq = 80 + Math.random() * 40;
            ambientOscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
        }
    }, 3000);
}

function stopAmbientSound() {
    if (ambientOscillator) {
        ambientOscillator.stop();
        ambientOscillator = null;
    }
}

// Drawing functions
function drawSky() {
    const gradient = ctx.createLinearGradient(0, 0, 0, height);
    gradient.addColorStop(0, colors.sky[0]);
    gradient.addColorStop(0.3, colors.sky[1]);
    gradient.addColorStop(0.7, colors.sky[2]);
    gradient.addColorStop(1, colors.sky[3]);
    
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, width, height);
}

function drawStars() {
    stars.forEach(star => {
        star.opacity += Math.sin(Date.now() * star.twinkleSpeed * 0.001) * 0.01;
        star.opacity = Math.max(0.2, Math.min(1, star.opacity));
        
        ctx.fillStyle = `rgba(255, 255, 255, ${star.opacity})`;
        ctx.beginPath();
        ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
        ctx.fill();
    });
}

function drawMoon() {
    const gradient = ctx.createRadialGradient(moon.x, moon.y, moon.radius * 0.5, moon.x, moon.y, moon.radius * 1.5);
    gradient.addColorStop(0, 'rgba(255, 255, 220, 0.3)');
    gradient.addColorStop(0.5, 'rgba(255, 255, 220, 0.1)');
    gradient.addColorStop(1, 'rgba(255, 255, 220, 0)');
    
    ctx.fillStyle = gradient;
    ctx.beginPath();
    ctx.arc(moon.x, moon.y, moon.radius * 1.5, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.fillStyle = '#ffffdc';
    ctx.beginPath();
    ctx.arc(moon.x, moon.y, moon.radius, 0, Math.PI * 2);
    ctx.fill();
    
    // Moon craters
    ctx.fillStyle = 'rgba(200, 200, 180, 0.3)';
    ctx.beginPath();
    ctx.arc(moon.x - 10, moon.y - 10, 8, 0, Math.PI * 2);
    ctx.fill();
    ctx.beginPath();
    ctx.arc(moon.x + 15, moon.y + 5, 6, 0, Math.PI * 2);
    ctx.fill();
}

function drawClouds() {
    if (!state.effects.clouds) return;
    
    clouds.forEach(cloud => {
        cloud.x += cloud.speed * state.speed;
        
        if (cloud.x > width + cloud.width) {
            cloud.x = -cloud.width;
        }
        
        ctx.fillStyle = `rgba(255, 255, 255, ${cloud.opacity})`;
        
        // Draw cloud as overlapping circles
        for (let i = 0; i < 5; i++) {
            const cx = cloud.x + (i / 4) * cloud.width;
            const cy = cloud.y + Math.sin(i) * cloud.height * 0.2;
            const r = cloud.height / 2 + Math.sin(i * 2) * 10;
            
            ctx.beginPath();
            ctx.arc(cx, cy, r, 0, Math.PI * 2);
            ctx.fill();
        }
    });
}

function drawBuildings() {
    buildings.forEach(building => {
        const brightness = building.layer === 'back' ? 0.6 : (building.layer === 'mid' ? 0.8 : 1.0);
        
        // Building shape
        ctx.fillStyle = building.color;
        ctx.globalAlpha = brightness;
        ctx.fillRect(building.x, building.y, building.w, building.h);
        
        // Building outline
        ctx.strokeStyle = 'rgba(0, 0, 0, 0.3)';
        ctx.lineWidth = 1;
        ctx.strokeRect(building.x, building.y, building.w, building.h);
        
        ctx.globalAlpha = 1;
        
        // Windows
        if (state.effects.windows) {
            building.windows.forEach(win => {
                if (Date.now() > win.nextFlicker) {
                    win.on = Math.random() < state.settings.windowDensity;
                    win.nextFlicker = Date.now() + Math.random() * 5000 + 2000;
                }
                
                if (win.on) {
                    const windowBrightness = state.settings.overallBrightness * brightness;
                    ctx.fillStyle = colors.window;
                    ctx.globalAlpha = 0.6 * windowBrightness;
                    ctx.fillRect(win.x, win.y, win.width, win.height);
                    
                    // Window glow
                    const gradient = ctx.createRadialGradient(
                        win.x + win.width / 2, win.y + win.height / 2, 0,
                        win.x + win.width / 2, win.y + win.height / 2, win.width
                    );
                    gradient.addColorStop(0, `rgba(255, 235, 179, ${0.3 * windowBrightness})`);
                    gradient.addColorStop(1, 'rgba(255, 235, 179, 0)');
                    ctx.fillStyle = gradient;
                    ctx.fillRect(win.x - 5, win.y - 5, win.width + 10, win.height + 10);
                    
                    ctx.globalAlpha = 1;
                }
            });
        }
    });
}

function drawGround() {
    // Ground/street
    ctx.fillStyle = '#1a1a2e';
    ctx.fillRect(0, height - 50, width, 50);
    
    // Street lights
    const streetLightSpacing = 200;
    for (let x = 100; x < width; x += streetLightSpacing) {
        // Light pole
        ctx.fillStyle = '#333';
        ctx.fillRect(x, height - 80, 3, 30);
        
        // Light glow
        const gradient = ctx.createRadialGradient(x + 1.5, height - 80, 0, x + 1.5, height - 80, 50);
        gradient.addColorStop(0, 'rgba(255, 214, 153, 0.4)');
        gradient.addColorStop(1, 'rgba(255, 214, 153, 0)');
        ctx.fillStyle = gradient;
        ctx.fillRect(x - 50, height - 120, 100, 70);
        
        // Light bulb
        ctx.fillStyle = colors.street;
        ctx.globalAlpha = 0.8;
        ctx.beginPath();
        ctx.arc(x + 1.5, height - 80, 4, 0, Math.PI * 2);
        ctx.fill();
        ctx.globalAlpha = 1;
    }
}

function drawTraffic() {
    if (!state.effects.traffic) return;
    
    cars.forEach((car, index) => {
        car.x += car.speed * state.speed;
        
        // Remove off-screen cars
        if (car.x < -50 || car.x > width + 50) {
            cars.splice(index, 1);
            return;
        }
        
        // Car body
        ctx.fillStyle = '#222';
        ctx.fillRect(car.x, car.y, car.width, car.height);
        
        // Headlights/taillights
        const gradient = ctx.createRadialGradient(
            car.speed > 0 ? car.x + car.width : car.x,
            car.y + car.height / 2,
            0,
            car.speed > 0 ? car.x + car.width : car.x,
            car.y + car.height / 2,
            30
        );
        gradient.addColorStop(0, car.color);
        gradient.addColorStop(1, `${car.color}00`);
        ctx.fillStyle = gradient;
        ctx.fillRect(
            car.speed > 0 ? car.x + car.width - 2 : car.x - 28,
            car.y - 10,
            30,
            car.height + 20
        );
    });
}

function drawFireworks() {
    if (!state.effects.fireworks) return;
    
    // Draw launching fireworks
    fireworks.forEach((fw, index) => {
        fw.y -= fw.speed * state.speed;
        
        if (fw.y <= fw.targetY) {
            explodeFirework(fw);
            fireworks.splice(index, 1);
            return;
        }
        
        ctx.fillStyle = fw.color;
        ctx.beginPath();
        ctx.arc(fw.x, fw.y, 3, 0, Math.PI * 2);
        ctx.fill();
        
        // Trail
        const gradient = ctx.createLinearGradient(fw.x, fw.y, fw.x, fw.y + 20);
        gradient.addColorStop(0, fw.color);
        gradient.addColorStop(1, `${fw.color}00`);
        ctx.fillStyle = gradient;
        ctx.fillRect(fw.x - 1, fw.y, 2, 20);
    });
    
    // Draw particles
    particles.forEach((p, index) => {
        p.x += p.vx * state.speed;
        p.y += p.vy * state.speed;
        p.vy += 0.05 * state.speed; // Gravity
        p.life -= p.decay * state.speed;
        
        if (p.life <= 0) {
            particles.splice(index, 1);
            return;
        }
        
        ctx.fillStyle = p.color;
        ctx.globalAlpha = p.life;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size * p.life, 0, Math.PI * 2);
        ctx.fill();
        ctx.globalAlpha = 1;
    });
}

function drawPlanes() {
    if (!state.effects.planes) return;
    
    planes.forEach((plane, index) => {
        plane.x += plane.speed * state.speed;
        
        if (plane.x < -100 || plane.x > width + 100) {
            planes.splice(index, 1);
            return;
        }
        
        plane.blinkPhase += 0.1 * state.speed;
        
        // Plane body
        ctx.fillStyle = '#666';
        ctx.fillRect(plane.x - plane.size * 2, plane.y, plane.size * 4, plane.size);
        
        // Wings
        ctx.fillRect(plane.x - plane.size * 3, plane.y + plane.size / 2, plane.size * 6, plane.size / 2);
        
        // Blinking lights
        if (Math.sin(plane.blinkPhase) > 0) {
            ctx.fillStyle = '#ff0000';
            ctx.beginPath();
            ctx.arc(plane.x - plane.size * 2, plane.y + plane.size / 2, 2, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = '#00ff00';
            ctx.beginPath();
            ctx.arc(plane.x + plane.size * 2, plane.y + plane.size / 2, 2, 0, Math.PI * 2);
            ctx.fill();
        }
    });
}

function drawRain() {
    if (!state.effects.rain || !state.settings.rainEnabled) return;
    
    raindrops.forEach((drop, index) => {
        drop.y += drop.speed * state.speed;
        
        if (drop.y > height) {
            raindrops.splice(index, 1);
            return;
        }
        
        ctx.strokeStyle = `rgba(174, 194, 224, ${drop.opacity})`;
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(drop.x, drop.y);
        ctx.lineTo(drop.x - 2, drop.y + drop.length);
        ctx.stroke();
    });
}

// Main animation loop
function animate() {
    drawSky();
    drawStars();
    drawMoon();
    drawClouds();
    drawBuildings();
    drawGround();
    drawTraffic();
    drawFireworks();
    drawPlanes();
    drawRain();
    
    // Create new entities
    createCar();
    createFirework();
    createPlane();
    if (state.settings.rainEnabled) {
        createRain();
    }
    
    requestAnimationFrame(animate);
}

// UI Control functions
function togglePanel() {
    const panel = document.getElementById('controlPanel');
    const expandBtn = document.getElementById('expandBtn');
    
    panel.classList.toggle('collapsed');
    
    if (panel.classList.contains('collapsed')) {
        expandBtn.classList.add('visible');
    } else {
        expandBtn.classList.remove('visible');
    }
}

function setScenery(scenery) {
    state.currentScenery = scenery;
    state.settings = { ...sceneryPresets[scenery] };
    
    // Update UI
    document.querySelectorAll('.scenery-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Update rain toggle
    const rainToggle = document.getElementById('toggleRain');
    if (state.settings.rainEnabled) {
        rainToggle.classList.add('active');
        state.effects.rain = true;
    } else {
        rainToggle.classList.remove('active');
        state.effects.rain = false;
    }
}

function toggleEffect(effect) {
    state.effects[effect] = !state.effects[effect];
    
    const toggle = document.getElementById(`toggle${effect.charAt(0).toUpperCase() + effect.slice(1)}`);
    toggle.classList.toggle('active');
    
    if (effect === 'sound') {
        if (state.effects.sound) {
            startAmbientSound();
        } else {
            stopAmbientSound();
        }
    }
    
    if (effect === 'rain') {
        state.settings.rainEnabled = state.effects.rain;
    }
}

function updateSpeed(value) {
    state.speed = parseFloat(value);
    document.getElementById('speedValue').textContent = value + 'x';
}

// Initialize
initBuildings();
animate();
    </script>
</body>
</html>