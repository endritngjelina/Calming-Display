<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cherry Blossom Garden - Meditative Experience</title>
    <style>
        :root {
            /* Primitive Color Tokens */
            --color-white: rgba(255, 255, 255, 1);
            --color-black: rgba(0, 0, 0, 1);
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-gray-400: rgba(119, 124, 124, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-brown-600: rgba(94, 82, 64, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-teal-300: rgba(50, 184, 198, 1);
            --color-teal-400: rgba(45, 166, 178, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-teal-700: rgba(26, 104, 115, 1);
            --color-teal-800: rgba(41, 150, 161, 1);
            --color-red-400: rgba(255, 84, 89, 1);
            --color-red-500: rgba(192, 21, 47, 1);
            --color-orange-400: rgba(230, 129, 97, 1);
            --color-orange-500: rgba(168, 75, 47, 1);

            /* RGB versions for opacity control */
            --color-brown-600-rgb: 94, 82, 64;
            --color-teal-500-rgb: 33, 128, 141;
            --color-slate-900-rgb: 19, 52, 59;
            --color-slate-500-rgb: 98, 108, 113;
            --color-red-500-rgb: 192, 21, 47;
            --color-red-400-rgb: 255, 84, 89;
            --color-orange-500-rgb: 168, 75, 47;
            --color-orange-400-rgb: 230, 129, 97;

            /* Semantic Color Tokens */
            --color-background: var(--color-cream-50);
            --color-surface: var(--color-cream-100);
            --color-text: var(--color-slate-900);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-border: rgba(var(--color-brown-600-rgb), 0.2);

            /* Typography */
            --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --font-size-xs: 11px;
            --font-size-sm: 12px;
            --font-size-base: 14px;
            --font-weight-medium: 500;
            --font-weight-semibold: 550;

            /* Spacing */
            --space-8: 8px;
            --space-12: 12px;
            --space-16: 16px;
            --space-20: 20px;

            /* Border Radius */
            --radius-base: 8px;
            --radius-lg: 12px;

            /* Shadows */
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);

            /* Animation */
            --duration-normal: 250ms;
            --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);
        }

        @font-face {
            font-family: 'FKGroteskNeue';
            src: url('https://r2cdn.perplexity.ai/fonts/FKGroteskNeue.woff2') format('woff2');
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family-base);
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        #garden-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transition: filter 0.5s ease;
        }

        #garden-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .scene-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transition: opacity 0.5s ease;
        }

        /* Control Panel */
        #control-panel {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: var(--space-20);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            max-height: 90vh;
            overflow-y: auto;
            z-index: 1000;
            width: 280px;
            transition: transform var(--duration-normal) var(--ease-standard);
        }

        #control-panel.hidden {
            transform: translate(320px, -50%);
        }

        #toggle-panel {
            position: fixed;
            right: 20px;
            top: 20px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: none;
            padding: 12px;
            border-radius: var(--radius-base);
            cursor: pointer;
            z-index: 1001;
            box-shadow: var(--shadow-lg);
            transition: background var(--duration-normal) var(--ease-standard);
        }

        #toggle-panel:hover {
            background: rgba(255, 255, 255, 1);
        }

        .control-section {
            margin-bottom: var(--space-20);
            padding-bottom: var(--space-16);
            border-bottom: 1px solid var(--color-border);
        }

        .control-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .control-section h3 {
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text);
            margin-bottom: var(--space-12);
        }

        .control-item {
            margin-bottom: var(--space-12);
        }

        .control-item label {
            display: block;
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            margin-bottom: 6px;
            font-weight: var(--font-weight-medium);
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
        }

        .toggle-switch input {
            display: none;
        }

        .toggle-slider {
            width: 44px;
            height: 24px;
            background: var(--color-border);
            border-radius: 12px;
            position: relative;
            transition: background var(--duration-normal) var(--ease-standard);
        }

        .toggle-slider::after {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: white;
            top: 3px;
            left: 3px;
            transition: transform var(--duration-normal) var(--ease-standard);
        }

        .toggle-switch input:checked + .toggle-slider {
            background: var(--color-primary);
        }

        .toggle-switch input:checked + .toggle-slider::after {
            transform: translateX(20px);
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--color-border);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--color-primary);
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--color-primary);
            cursor: pointer;
            border: none;
        }

        .slider-value {
            display: inline-block;
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
            margin-left: var(--space-8);
        }

        .color-options {
            display: flex;
            gap: var(--space-8);
            flex-wrap: wrap;
        }

        .color-option {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-base);
            cursor: pointer;
            border: 2px solid transparent;
            transition: all var(--duration-normal) var(--ease-standard);
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.active {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(var(--color-teal-500-rgb), 0.2);
        }

        .action-buttons {
            display: flex;
            gap: var(--space-8);
            flex-direction: column;
        }

        .btn {
            padding: var(--space-12) var(--space-16);
            border: none;
            border-radius: var(--radius-base);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all var(--duration-normal) var(--ease-standard);
            font-family: var(--font-family-base);
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
        }

        .btn-secondary {
            background: rgba(var(--color-brown-600-rgb), 0.12);
            color: var(--color-text);
        }

        .btn-secondary:hover {
            background: rgba(var(--color-brown-600-rgb), 0.2);
        }

        /* Fullscreen styles */
        .fullscreen #control-panel {
            max-height: 100vh;
        }

        /* Scrollbar styling */
        #control-panel::-webkit-scrollbar {
            width: 6px;
        }

        #control-panel::-webkit-scrollbar-track {
            background: transparent;
        }

        #control-panel::-webkit-scrollbar-thumb {
            background: var(--color-border);
            border-radius: 3px;
        }

        #control-panel::-webkit-scrollbar-thumb:hover {
            background: var(--color-text-secondary);
        }
    </style>
</head>
<body>
    <div id="garden-container">
        <canvas id="garden-canvas"></canvas>
    </div>

    <button id="toggle-panel" aria-label="Toggle Controls">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M12 1v6m0 6v6m9-9h-6m-6 0H3"></path>
        </svg>
    </button>

    <div id="control-panel">
        <div class="control-section">
            <h3>Scene Elements</h3>
            <div class="control-item">
                <label class="toggle-switch">
                    <span>Cherry Trees</span>
                    <input type="checkbox" id="toggle-trees" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="control-item">
                <label class="toggle-switch">
                    <span>Falling Petals</span>
                    <input type="checkbox" id="toggle-petals" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="control-item">
                <label class="toggle-switch">
                    <span>River</span>
                    <input type="checkbox" id="toggle-river" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="control-item">
                <label class="toggle-switch">
                    <span>Stone Path</span>
                    <input type="checkbox" id="toggle-path" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <div class="control-section">
            <h3>Animations</h3>
            <div class="control-item">
                <label>
                    Petal Speed <span class="slider-value" id="petal-speed-value">1.0x</span>
                </label>
                <input type="range" id="petal-speed" min="50" max="200" value="100" step="10">
            </div>
            <div class="control-item">
                <label>
                    Water Flow <span class="slider-value" id="water-speed-value">1.0x</span>
                </label>
                <input type="range" id="water-speed" min="50" max="200" value="100" step="10">
            </div>
            <div class="control-item">
                <label>
                    Petal Density <span class="slider-value" id="density-value">Medium</span>
                </label>
                <input type="range" id="petal-density" min="1" max="3" value="2" step="1">
            </div>
        </div>

        <div class="control-section">
            <h3>Blossom Colors</h3>
            <div class="color-options">
                <div class="color-option active" data-color="soft-pink" style="background: linear-gradient(135deg, #FFB6C1, #FFC0CB);"></div>
                <div class="color-option" data-color="deep-pink" style="background: linear-gradient(135deg, #FF69B4, #FF1493);"></div>
                <div class="color-option" data-color="white" style="background: linear-gradient(135deg, #FFFFFF, #F0F0F0);"></div>
                <div class="color-option" data-color="rainbow" style="background: linear-gradient(135deg, #FFB6C1, #DDA0DD, #B0C4DE);"></div>
            </div>
        </div>

        <div class="control-section">
            <h3>Atmosphere</h3>
            <div class="control-item">
                <label class="toggle-switch">
                    <span>Day/Night Mode</span>
                    <input type="checkbox" id="toggle-night" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="control-item">
                <label>
                    Bloom Intensity <span class="slider-value" id="bloom-value">50%</span>
                </label>
                <input type="range" id="bloom-intensity" min="0" max="100" value="50" step="5">
            </div>
        </div>

        <div class="control-section">
            <div class="action-buttons">
                <button class="btn btn-primary" id="play-pause">⏸ Pause</button>
                <button class="btn btn-secondary" id="fullscreen">⛶ Fullscreen</button>
                <button class="btn btn-secondary" id="reset">↻ Reset</button>
            </div>
        </div>
    </div>

    <script>
        // Cherry Blossom Garden Application
class CherryBlossomGarden {
    constructor() {
        this.canvas = document.getElementById('garden-canvas');
        this.ctx = this.canvas.getContext('2d');
        this.resizeCanvas();
        
        // State management
        this.state = {
            trees: true,
            petals: true,
            river: true,
            path: true,
            petalSpeed: 1.0,
            waterSpeed: 1.0,
            petalDensity: 2,
            blossomColor: 'soft-pink',
            isDay: true,
            bloomIntensity: 0.5,
            isPaused: false,
            isFullscreen: false
        };
        
        // Animation state
        this.time = 0;
        this.petals = [];
        this.riverOffset = 0;
        this.pathGlowOffset = 0;
        
        this.initializePetals();
        this.setupEventListeners();
        this.animate();
        
        window.addEventListener('resize', () => this.resizeCanvas());
    }
    
    resizeCanvas() {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
    }
    
    initializePetals() {
        this.petals = [];
        const density = this.state.petalDensity === 1 ? 30 : this.state.petalDensity === 2 ? 60 : 100;
        for (let i = 0; i < density; i++) {
            this.petals.push(this.createPetal());
        }
    }
    
    createPetal() {
        return {
            x: Math.random() * this.canvas.width,
            y: Math.random() * this.canvas.height - this.canvas.height,
            size: Math.random() * 6 + 3,
            speedY: Math.random() * 1 + 0.5,
            speedX: Math.random() * 0.5 - 0.25,
            rotation: Math.random() * Math.PI * 2,
            rotationSpeed: Math.random() * 0.02 - 0.01,
            opacity: Math.random() * 0.5 + 0.5,
            swing: Math.random() * Math.PI * 2,
            swingSpeed: Math.random() * 0.02 + 0.01
        };
    }
    
    getBlossomColors() {
        const colors = {
            'soft-pink': {
                tree: ['#FFB6C1', '#FFC0CB', '#FFE4E1'],
                petal: ['#FFB6C1', '#FFC0CB', '#FADADD']
            },
            'deep-pink': {
                tree: ['#FF69B4', '#FF1493', '#FF6B9D'],
                petal: ['#FF69B4', '#FF1493', '#FF85A1']
            },
            'white': {
                tree: ['#FFFFFF', '#F8F8FF', '#FFFAFA'],
                petal: ['#FFFFFF', '#F5F5F5', '#FAFAFA']
            },
            'rainbow': {
                tree: ['#FFB6C1', '#DDA0DD', '#B0C4DE', '#FFE4E1'],
                petal: ['#FFB6C1', '#DDA0DD', '#B0C4DE', '#FADADD']
            }
        };
        return colors[this.state.blossomColor];
    }
    
    drawBackground() {
        const gradient = this.ctx.createLinearGradient(0, 0, 0, this.canvas.height);
        
        if (this.state.isDay) {
            gradient.addColorStop(0, '#87CEEB');
            gradient.addColorStop(0.5, '#B0E0E6');
            gradient.addColorStop(1, '#F0E68C');
        } else {
            gradient.addColorStop(0, '#191970');
            gradient.addColorStop(0.5, '#2C3E50');
            gradient.addColorStop(1, '#34495E');
        }
        
        this.ctx.fillStyle = gradient;
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
    }
    
    drawMountains() {
        const mountainColor = this.state.isDay ? 'rgba(100, 120, 140, 0.6)' : 'rgba(40, 50, 60, 0.8)';
        
        // Far mountains
        this.ctx.fillStyle = mountainColor;
        this.ctx.beginPath();
        this.ctx.moveTo(0, this.canvas.height * 0.4);
        this.ctx.lineTo(this.canvas.width * 0.2, this.canvas.height * 0.25);
        this.ctx.lineTo(this.canvas.width * 0.4, this.canvas.height * 0.35);
        this.ctx.lineTo(this.canvas.width * 0.6, this.canvas.height * 0.28);
        this.ctx.lineTo(this.canvas.width * 0.8, this.canvas.height * 0.38);
        this.ctx.lineTo(this.canvas.width, this.canvas.height * 0.3);
        this.ctx.lineTo(this.canvas.width, this.canvas.height);
        this.ctx.lineTo(0, this.canvas.height);
        this.ctx.closePath();
        this.ctx.fill();
    }
    
    drawGrass() {
        const grassGradient = this.ctx.createLinearGradient(0, this.canvas.height * 0.5, 0, this.canvas.height);
        
        if (this.state.isDay) {
            grassGradient.addColorStop(0, '#90EE90');
            grassGradient.addColorStop(1, '#228B22');
        } else {
            grassGradient.addColorStop(0, '#2F4F2F');
            grassGradient.addColorStop(1, '#1C3B1C');
        }
        
        this.ctx.fillStyle = grassGradient;
        this.ctx.fillRect(0, this.canvas.height * 0.5, this.canvas.width, this.canvas.height * 0.5);
    }
    
    drawRiver() {
        if (!this.state.river) return;
        
        const riverY = this.canvas.height * 0.6;
        const riverHeight = this.canvas.height * 0.25;
        
        // River base
        const riverGradient = this.ctx.createLinearGradient(0, riverY, 0, riverY + riverHeight);
        if (this.state.isDay) {
            riverGradient.addColorStop(0, 'rgba(135, 206, 235, 0.6)');
            riverGradient.addColorStop(1, 'rgba(70, 130, 180, 0.8)');
        } else {
            riverGradient.addColorStop(0, 'rgba(25, 42, 86, 0.8)');
            riverGradient.addColorStop(1, 'rgba(13, 27, 42, 0.9)');
        }
        
        this.ctx.fillStyle = riverGradient;
        this.ctx.beginPath();
        this.ctx.moveTo(0, riverY);
        
        // Winding river path
        for (let x = 0; x <= this.canvas.width; x += 20) {
            const wave = Math.sin((x * 0.01) + (this.riverOffset * 0.5)) * 30;
            this.ctx.lineTo(x, riverY + wave);
        }
        
        for (let x = this.canvas.width; x >= 0; x -= 20) {
            const wave = Math.sin((x * 0.01) + (this.riverOffset * 0.5)) * 30;
            this.ctx.lineTo(x, riverY + riverHeight + wave);
        }
        
        this.ctx.closePath();
        this.ctx.fill();
        
        // Water shimmer effects
        this.ctx.globalAlpha = 0.3;
        for (let i = 0; i < 10; i++) {
            const shimmerX = (this.riverOffset * 2 + i * 50) % this.canvas.width;
            const shimmerY = riverY + Math.random() * riverHeight;
            const shimmerSize = Math.random() * 30 + 10;
            
            const shimmerGradient = this.ctx.createRadialGradient(
                shimmerX, shimmerY, 0,
                shimmerX, shimmerY, shimmerSize
            );
            shimmerGradient.addColorStop(0, 'rgba(255, 255, 255, 0.6)');
            shimmerGradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
            
            this.ctx.fillStyle = shimmerGradient;
            this.ctx.fillRect(shimmerX - shimmerSize, shimmerY - shimmerSize, shimmerSize * 2, shimmerSize * 2);
        }
        this.ctx.globalAlpha = 1;
    }
    
    drawPath() {
        if (!this.state.path) return;
        
        const pathY = this.canvas.height * 0.7;
        const pathWidth = 120;
        
        // Path base
        this.ctx.fillStyle = this.state.isDay ? 'rgba(139, 137, 137, 0.7)' : 'rgba(80, 80, 80, 0.8)';
        this.ctx.beginPath();
        
        for (let y = pathY; y < this.canvas.height; y += 10) {
            const progress = (y - pathY) / (this.canvas.height - pathY);
            const width = pathWidth * (1 + progress * 0.5);
            const centerX = this.canvas.width * 0.3 + Math.sin(y * 0.01) * 50;
            
            this.ctx.moveTo(centerX - width / 2, y);
            this.ctx.lineTo(centerX + width / 2, y);
        }
        this.ctx.fill();
        
        // Stones on path
        this.ctx.globalAlpha = 0.8;
        for (let i = 0; i < 15; i++) {
            const stoneY = pathY + (i * (this.canvas.height - pathY) / 15);
            const progress = (stoneY - pathY) / (this.canvas.height - pathY);
            const centerX = this.canvas.width * 0.3 + Math.sin(stoneY * 0.01) * 50;
            const stoneX = centerX + (Math.random() - 0.5) * pathWidth * (1 + progress * 0.5) * 0.6;
            const stoneSize = 15 + Math.random() * 10 + progress * 10;
            
            // Stone glow effect
            const glowIntensity = Math.sin(this.pathGlowOffset + i * 0.5) * 0.5 + 0.5;
            if (this.state.bloomIntensity > 0 && glowIntensity > 0.7) {
                const glowGradient = this.ctx.createRadialGradient(
                    stoneX, stoneY, 0,
                    stoneX, stoneY, stoneSize * 2
                );
                glowGradient.addColorStop(0, `rgba(255, 255, 200, ${this.state.bloomIntensity * 0.3})`);
                glowGradient.addColorStop(1, 'rgba(255, 255, 200, 0)');
                this.ctx.fillStyle = glowGradient;
                this.ctx.fillRect(stoneX - stoneSize * 2, stoneY - stoneSize * 2, stoneSize * 4, stoneSize * 4);
            }
            
            this.ctx.fillStyle = this.state.isDay ? 'rgba(169, 169, 169, 0.9)' : 'rgba(105, 105, 105, 0.9)';
            this.ctx.beginPath();
            this.ctx.arc(stoneX, stoneY, stoneSize, 0, Math.PI * 2);
            this.ctx.fill();
        }
        this.ctx.globalAlpha = 1;
    }
    
    drawTree(x, y, trunkHeight, branchSpread, colors) {
        // Trunk
        this.ctx.fillStyle = this.state.isDay ? '#5D4037' : '#3E2723';
        this.ctx.fillRect(x - 15, y, 30, trunkHeight);
        
        // Main branches
        this.ctx.strokeStyle = this.state.isDay ? '#5D4037' : '#3E2723';
        this.ctx.lineWidth = 8;
        this.ctx.lineCap = 'round';
        
        for (let i = 0; i < 5; i++) {
            const angle = (Math.PI / 4) * (i - 2);
            const branchLength = branchSpread * 0.8;
            const startY = y + trunkHeight * (0.3 + i * 0.15);
            
            this.ctx.beginPath();
            this.ctx.moveTo(x, startY);
            this.ctx.lineTo(
                x + Math.cos(angle) * branchLength,
                startY - Math.sin(angle) * branchLength
            );
            this.ctx.stroke();
        }
        
        // Blossom clusters
        for (let i = 0; i < 30; i++) {
            const angle = Math.random() * Math.PI * 2;
            const radius = Math.random() * branchSpread;
            const clusterX = x + Math.cos(angle) * radius;
            const clusterY = y + trunkHeight * 0.3 - Math.sin(Math.abs(angle)) * radius * 0.5;
            
            const blossomSize = Math.random() * 20 + 15;
            const color = colors[Math.floor(Math.random() * colors.length)];
            
            // Bloom glow
            if (this.state.bloomIntensity > 0) {
                const glowGradient = this.ctx.createRadialGradient(
                    clusterX, clusterY, 0,
                    clusterX, clusterY, blossomSize * 2
                );
                glowGradient.addColorStop(0, `${color}${Math.floor(this.state.bloomIntensity * 255).toString(16).padStart(2, '0')}`);
                glowGradient.addColorStop(1, `${color}00`);
                this.ctx.fillStyle = glowGradient;
                this.ctx.fillRect(clusterX - blossomSize * 2, clusterY - blossomSize * 2, blossomSize * 4, blossomSize * 4);
            }
            
            this.ctx.fillStyle = color;
            this.ctx.globalAlpha = 0.7 + Math.random() * 0.3;
            this.ctx.beginPath();
            this.ctx.arc(clusterX, clusterY, blossomSize, 0, Math.PI * 2);
            this.ctx.fill();
        }
        this.ctx.globalAlpha = 1;
    }
    
    drawTrees() {
        if (!this.state.trees) return;
        
        const colors = this.getBlossomColors().tree;
        
        // Background trees
        this.ctx.globalAlpha = 0.5;
        this.drawTree(this.canvas.width * 0.15, this.canvas.height * 0.45, 80, 100, colors);
        this.drawTree(this.canvas.width * 0.85, this.canvas.height * 0.48, 70, 90, colors);
        this.ctx.globalAlpha = 1;
        
        // Foreground trees
        this.drawTree(this.canvas.width * 0.1, this.canvas.height * 0.3, 150, 180, colors);
        this.drawTree(this.canvas.width * 0.7, this.canvas.height * 0.35, 140, 170, colors);
        this.drawTree(this.canvas.width * 0.9, this.canvas.height * 0.25, 160, 190, colors);
    }
    
    updatePetals() {
        if (!this.state.petals) return;
        
        this.petals.forEach(petal => {
            petal.y += petal.speedY * this.state.petalSpeed;
            petal.x += petal.speedX * this.state.petalSpeed;
            petal.x += Math.sin(petal.swing) * 2;
            petal.swing += petal.swingSpeed;
            petal.rotation += petal.rotationSpeed;
            
            if (petal.y > this.canvas.height) {
                petal.y = -20;
                petal.x = Math.random() * this.canvas.width;
            }
            if (petal.x < -20) petal.x = this.canvas.width + 20;
            if (petal.x > this.canvas.width + 20) petal.x = -20;
        });
    }
    
    drawPetals() {
        if (!this.state.petals) return;
        
        const colors = this.getBlossomColors().petal;
        
        this.petals.forEach(petal => {
            this.ctx.save();
            this.ctx.translate(petal.x, petal.y);
            this.ctx.rotate(petal.rotation);
            this.ctx.globalAlpha = petal.opacity;
            
            const color = colors[Math.floor(Math.random() * colors.length)];
            this.ctx.fillStyle = color;
            
            // Draw petal shape
            this.ctx.beginPath();
            this.ctx.ellipse(0, 0, petal.size, petal.size * 1.5, 0, 0, Math.PI * 2);
            this.ctx.fill();
            
            this.ctx.restore();
        });
        
        this.ctx.globalAlpha = 1;
    }
    
    animate() {
        if (!this.state.isPaused) {
            this.time += 0.01;
            this.riverOffset += 1 * this.state.waterSpeed;
            this.pathGlowOffset += 0.05;
            
            this.drawBackground();
            this.drawMountains();
            this.drawGrass();
            this.drawRiver();
            this.drawPath();
            this.drawTrees();
            this.updatePetals();
            this.drawPetals();
        }
        
        requestAnimationFrame(() => this.animate());
    }
    
    setupEventListeners() {
        // Toggle panel
        document.getElementById('toggle-panel').addEventListener('click', () => {
            document.getElementById('control-panel').classList.toggle('hidden');
        });
        
        // Scene elements
        document.getElementById('toggle-trees').addEventListener('change', (e) => {
            this.state.trees = e.target.checked;
        });
        
        document.getElementById('toggle-petals').addEventListener('change', (e) => {
            this.state.petals = e.target.checked;
        });
        
        document.getElementById('toggle-river').addEventListener('change', (e) => {
            this.state.river = e.target.checked;
        });
        
        document.getElementById('toggle-path').addEventListener('change', (e) => {
            this.state.path = e.target.checked;
        });
        
        // Petal speed
        document.getElementById('petal-speed').addEventListener('input', (e) => {
            this.state.petalSpeed = e.target.value / 100;
            document.getElementById('petal-speed-value').textContent = `${this.state.petalSpeed.toFixed(1)}x`;
        });
        
        // Water speed
        document.getElementById('water-speed').addEventListener('input', (e) => {
            this.state.waterSpeed = e.target.value / 100;
            document.getElementById('water-speed-value').textContent = `${this.state.waterSpeed.toFixed(1)}x`;
        });
        
        // Petal density
        document.getElementById('petal-density').addEventListener('input', (e) => {
            this.state.petalDensity = parseInt(e.target.value);
            const labels = ['Low', 'Medium', 'High'];
            document.getElementById('density-value').textContent = labels[this.state.petalDensity - 1];
            this.initializePetals();
        });
        
        // Color options
        document.querySelectorAll('.color-option').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.color-option').forEach(o => o.classList.remove('active'));
                option.classList.add('active');
                this.state.blossomColor = option.dataset.color;
            });
        });
        
        // Day/Night toggle
        document.getElementById('toggle-night').addEventListener('change', (e) => {
            this.state.isDay = e.target.checked;
        });
        
        // Bloom intensity
        document.getElementById('bloom-intensity').addEventListener('input', (e) => {
            this.state.bloomIntensity = e.target.value / 100;
            document.getElementById('bloom-value').textContent = `${e.target.value}%`;
        });
        
        // Play/Pause
        document.getElementById('play-pause').addEventListener('click', () => {
            this.state.isPaused = !this.state.isPaused;
            const btn = document.getElementById('play-pause');
            btn.textContent = this.state.isPaused ? '▶ Play' : '⏸ Pause';
        });
        
        // Fullscreen
        document.getElementById('fullscreen').addEventListener('click', () => {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
                this.state.isFullscreen = true;
            } else {
                document.exitFullscreen();
                this.state.isFullscreen = false;
            }
        });
        
        // Reset
        document.getElementById('reset').addEventListener('click', () => {
            this.state = {
                trees: true,
                petals: true,
                river: true,
                path: true,
                petalSpeed: 1.0,
                waterSpeed: 1.0,
                petalDensity: 2,
                blossomColor: 'soft-pink',
                isDay: true,
                bloomIntensity: 0.5,
                isPaused: false,
                isFullscreen: this.state.isFullscreen
            };
            
            // Reset UI
            document.getElementById('toggle-trees').checked = true;
            document.getElementById('toggle-petals').checked = true;
            document.getElementById('toggle-river').checked = true;
            document.getElementById('toggle-path').checked = true;
            document.getElementById('toggle-night').checked = true;
            document.getElementById('petal-speed').value = 100;
            document.getElementById('water-speed').value = 100;
            document.getElementById('petal-density').value = 2;
            document.getElementById('bloom-intensity').value = 50;
            document.getElementById('petal-speed-value').textContent = '1.0x';
            document.getElementById('water-speed-value').textContent = '1.0x';
            document.getElementById('density-value').textContent = 'Medium';
            document.getElementById('bloom-value').textContent = '50%';
            document.getElementById('play-pause').textContent = '⏸ Pause';
            
            document.querySelectorAll('.color-option').forEach(o => o.classList.remove('active'));
            document.querySelector('[data-color="soft-pink"]').classList.add('active');
            
            this.initializePetals();
        });
    }
}

// Initialize the garden when the page loads
window.addEventListener('DOMContentLoaded', () => {
    new CherryBlossomGarden();
});
    </script>
</body>
</html>